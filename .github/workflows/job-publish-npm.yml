name: job-publish-npm
run-name: "[job-publish-npm] ${{ inputs.branch }} - ${{ inputs.npmTag }}"

on:
  workflow_call:
    inputs:
      branch:
        description: 'Branch to checkout'
        required: true
        type: string
      npmTag:
        description: 'NPM tag to use for publish (e.g. latest, canary)'
        required: true
        type: string
    secrets:
      BUN_VERSION:
        required: false
      KEY_SSH:
        required: true
      NPM_TOKEN:
        required: true

jobs:
  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0
          ssh-key: ${{ secrets.KEY_SSH }}

      - name: Setup Bun Project
        uses: ./.github/actions/setup-bun-project
        with:
          bun-version: ${{ secrets.BUN_VERSION || 'latest' }}

      - name: Build
        run: bun run build

      - name: Clean CHANGELOG
        run: rm -f CHANGELOG.md

      - name: Publish to NPM
        id: publish
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          version=$(jq -r .version package.json)
          name=$(jq -r .name package.json)
          if bun publish --access public --tag ${{ inputs.npmTag }}; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "version=$version" >> $GITHUB_OUTPUT
            echo "name=$name" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "version=$version" >> $GITHUB_OUTPUT
            echo "name=$name" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Summary
        run: |
          version="${{ steps.publish.outputs.version }}"
          name="${{ steps.publish.outputs.name }}"
          status="${{ steps.publish.outputs.status }}"
          branch="${{ inputs.branch }}"
          tag="${{ inputs.npmTag }}"
          
          if [ "$status" = "success" ]; then
            status_icon="âœ… Success"
            message="NPM publication completed successfully."
          else
            status_icon="âŒ Failed"
            message="NPM publication failed."
          fi
          
          npm_url="https://www.npmjs.com/package/$name/v/$version"
          
          {
            echo ""
            echo "## ðŸ“¦ NPM Publish Summary"
            echo ""
            echo "| Branch | NPM Tag | Version | Status | NPM Link |"
            echo "|:------:|:-------:|:-------:|:------:|:--------:|"
            echo "| $branch | $tag | $version | $status_icon | [View on npm]($npm_url) |"
            echo ""
            echo "$message"
          } >> $GITHUB_STEP_SUMMARY
